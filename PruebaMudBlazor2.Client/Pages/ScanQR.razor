@attribute [Authorize(Roles = "Admin")]
@using Microsoft.AspNetCore.Authorization
@page "/scanqr"
@inject Services.ISindicatoService SindicatoService
@inject Services.IEventosApiClient EventosApi

@inject IJSRuntime JS
@inject HttpClient Http
@inject ISnackbar snack

@using PruebaMudBlazor2.Shared.Models



<MudTabs Class="mt-5">
  <MudTabPanel Text="Desde Mobil" Icon="@Icons.Material.Outlined.MobileFriendly">
    <div class="qr-container">
      <MudPaper Class="pa-5">
        <div class="qr-in">

          <MudButton @onclick="StartScanning" Variant="Variant.Filled" Class="ma-5" Raised
            EndIcon="@Icons.Material.Filled.QrCodeScanner"
            Disabled="@(!_isConected || selectedEventosAño == null || !_isPrinterSelected)">
            Start QR Scanner
          </MudButton>

          <div id="qr-reader" style="width: 300px;margin: auto;"></div>
          <MudText Typo="Typo.h6">Scanned QR Code: @qrResult</MudText>
          <br>

        </div>


      </MudPaper>
    </div>
  </MudTabPanel>
  <MudTabPanel Text="Manualmente" Icon="@Icons.Material.Outlined.Dialpad">
    <div class="">
      <MudPaper Class="pa-5 d-flex flexwrap">
        <MudTextField @bind-Value="qrNroReserva" Label="Nro de reserva" Placeholder="Ingerse numero de reserva"
          @ref="txtNroReservaManual" Variant="Variant.Text" @onkeydown="@sendKeyEnter"
          Disabled="@(!_isConected && _isLoading || selectedEventosAño == null)">
        </MudTextField>
        <MudButton @onclick="sendPrinting" Variant="Variant.Filled" Class="ma-5" Raised
          EndIcon="@Icons.Material.Filled.CheckCircleOutline"
          Disabled="@(!_isConected && _isLoading || selectedEventosAño == null || !_isPrinterSelected)">
          Validar
        </MudButton>
        <MudButton @onclick="sendPrintingTest" Variant="Variant.Filled" Class="ma-5" Raised
          EndIcon="@Icons.Material.Filled.Print"
          Disabled="@(!_isConected && _isLoading || selectedEventosAño == null || !_isPrinterSelected)">
          TestPrint
        </MudButton>
      </MudPaper>
    </div>
  </MudTabPanel>

</MudTabs>

<MudPaper Class="mt-5 pa-5">
  <Printers SendData="HandleData" />
</MudPaper>

<MudPaper Class="pa-4">
  <MudSelect T="EventosAño" Label="Seleccione un Evento del Año" @bind-Value="selectedEventosAño"
    ToStringFunc="@(ea => ea?.NombreEvento ?? string.Empty)" Variant="Variant.Filled" Required="true"
    RequiredError="Debe seleccionar un evento.">
    @if (eventosAñoList != null)
    {
      @foreach (var ea in eventosAñoList)
      {
        <MudSelectItem Value="ea">@ea.NombreEvento</MudSelectItem>
      }
    }
  </MudSelect>
</MudPaper>

@code {
  private MudTextField<string> txtNroReservaManual;

  private string qrNroReserva;
  private List<string> printers = null;
  private string qrResult = "Waiting for scan...";

  private DotNetObjectReference<ScanQR>? objRef;

  private bool _isConected = false;
  private bool _isLoading = false;
  private bool _isPrinterSelected = false; // ADD THIS

  public int idPrinter;
  private string serverIp;

  // New properties for EventosAño selection
  private List<EventosAño> eventosAñoList = new();
  private EventosAño? selectedEventosAño;
  private int selectedEventosAñoId => selectedEventosAño?.Id ?? 0;

  private void HandleResult(bool result)
  {
    _isConected = result;
  }

  private void HandleData(Printers.DataParam result)
  {
    idPrinter = result.idPrinter;
    _isConected = result.isConected;
    serverIp = result.serverIp;
    _isPrinterSelected = result.isPrinterSelected; // ADD THIS
    Console.WriteLine(idPrinter);
  }

  protected override async Task OnInitializedAsync()
  {
    await LoadFilteredEventosAño();
    StateHasChanged();
    objRef = DotNetObjectReference.Create(this);
  }

  private async Task LoadFilteredEventosAño()
  {
    try
    {
      eventosAñoList = await EventosApi.GetEventosAñoFiltered(4, 1);
      // Select the first item by default as requested by the user
      selectedEventosAño = eventosAñoList.FirstOrDefault();
    }
    catch (Exception ex)
    {
      snack.Add($"Error al cargar eventos: {ex.Message}", Severity.Error);
    }
  }

  protected async ValueTask DisposeAsync(bool disposing)
  {
    objRef?.Dispose();
  }

  private async Task StartScanning()
  {
    if (selectedEventosAñoId == 0)
    {
      snack.Add("Por favor, seleccione un evento primero.", Severity.Warning);
      return;
    }
    if (!_isPrinterSelected) // ADD THIS
    {
      snack.Add("Por favor, seleccione una impresora primero.", Severity.Warning); // ADD THIS
      return; // ADD THIS
    }
    await JS.InvokeVoidAsync("startQrScanner", [objRef, Http]);
  }

  [JSInvokable]
  public async void OnQrCodeScanned(string result)
  {
    if (selectedEventosAñoId == 0)
    {
      snack.Add("Error: No hay un evento seleccionado.", Severity.Error);
      return;
    }
    if (!_isPrinterSelected) // ADD THIS
    {
      snack.Add("Por favor, seleccione una impresora primero.", Severity.Warning); // ADD THIS
      return; // ADD THIS
    }

    if (qrResult != result)
    {
      var estaReservado = await SindicatoService.YaFueEntregado(Convert.ToInt32(result), selectedEventosAñoId);

      if (!estaReservado)
      {
        var res = await SindicatoService.GetReservaImpresion(Convert.ToInt32(result), selectedEventosAñoId);
        qrResult = result; // Missing line, adding for consistency
        var reserva = new Reserva
        {
          NroReserva = res.NroReserva,
          NroSocio = res.NroSocio.ToString(),
          ApellidoNombreSocio = res.ApellidoNombreSocio,
          dni = res.dni.ToString(),
          Familiares = res.Familiares.ToList(),
          Regalos = res.Regalos.ToList(),
          idPrinter = idPrinter
        };
        await Http.PostAsJsonAsync($"/api/PrinterProxy/generateTicket/{serverIp}", reserva);
        snack.Add("Scaneado correcto Reserva nro: " + result, Severity.Success);
        StateHasChanged();
      }
      else
      {
        snack.Add("La reserva Nº " + result + " Ya Fue Retirada", Severity.Warning);
      }
    }
  }



  private async Task sendPrinting()
  {
    if (selectedEventosAñoId == 0)
    {
      snack.Add("Por favor, seleccione un evento primero.", Severity.Warning);
      return;
    }
    if (!_isPrinterSelected) // ADD THIS
    {
      snack.Add("Por favor, seleccione una impresora primero.", Severity.Warning); // ADD THIS
      return; // ADD THIS
    }
    if (string.IsNullOrEmpty(qrNroReserva))
    {
      return;
    }

    _isLoading = true;

    if (qrResult != qrNroReserva)
    {
      try
      {
        var estaReservado = await SindicatoService.YaFueEntregado(Convert.ToInt32(qrNroReserva), selectedEventosAñoId);

        if (!estaReservado)
        {
          var res = await SindicatoService.GetReservaImpresion(Convert.ToInt32(qrNroReserva), selectedEventosAñoId);
          qrResult = qrNroReserva;
          var reserva = new Reserva
          {
            NroReserva = res.NroReserva,
            NroSocio = res.NroSocio.ToString(),
            ApellidoNombreSocio = res.ApellidoNombreSocio,
            dni = res.dni.ToString(),
            Familiares = res.Familiares.ToList(),
            Regalos = res.Regalos.ToList(),
            idPrinter = idPrinter
          };

          await Http.PostAsJsonAsync($"/api/PrinterProxy/generateTicket/{serverIp}", reserva);
          snack.Add("Scaneado correcto Reserva nro: " + qrNroReserva, Severity.Success);
          StateHasChanged();
        }
        else
        {
          snack.Add("La reserva Nº " + qrNroReserva + " Ya Fue Retirada", Severity.Warning);
        }
      }
      catch (Exception ex)
      {
        snack.Add($"Error al generar reserva: {ex.Message}", Severity.Error);
      }
      finally
      {
        _isLoading = false;
        await txtNroReservaManual.Clear();
      }
    }
  }



  private async Task sendPrintingTest()
  {
    if (selectedEventosAñoId == 0)
    {
      snack.Add("Por favor, seleccione un evento primero.", Severity.Warning);
      return;
    }
    if (!_isPrinterSelected) // ADD THIS
    {
      snack.Add("Por favor, seleccione una impresora primero.", Severity.Warning); // ADD THIS
      return; // ADD THIS
    }
    if (string.IsNullOrEmpty(qrNroReserva))
    {
      return;
    }

    _isLoading = true;

    if (qrResult != qrNroReserva)
    {
      try
      {
        var estaReservado = await SindicatoService.YaFueEntregado(Convert.ToInt32(qrNroReserva), selectedEventosAñoId);

        if (estaReservado)
        {
          var res = await SindicatoService.GetReservaImpresion(Convert.ToInt32(qrNroReserva), selectedEventosAñoId);
          qrResult = qrNroReserva;
          var reserva = new Reserva
          {
            NroReserva = res.NroReserva,
            NroSocio = res.NroSocio.ToString(),
            ApellidoNombreSocio = res.ApellidoNombreSocio,
            dni = res.dni.ToString(),
            Familiares = res.Familiares.ToList(),
            Regalos = res.Regalos.ToList(),
            idPrinter = idPrinter
          };

          await Http.PostAsJsonAsync($"/api/PrinterProxy/generateTicket/{serverIp}", reserva);
          snack.Add("Scaneado correcto Reserva nro: " + qrNroReserva, Severity.Success);
          StateHasChanged();
        }
        else
        {
          snack.Add("La reserva Nº " + qrNroReserva + " Ya Fue Retirada", Severity.Warning);
        }
      }
      catch (Exception ex)
      {
        snack.Add($"Error al generar reserva: {ex.Message}", Severity.Error);
      }
      finally
      {
        _isLoading = false;
        await txtNroReservaManual.Clear();
      }
    }
  }


  private async void sendKeyEnter(KeyboardEventArgs e)
  {
    if (e.Code == "Enter" || e.Code == "NumpadEnter")
    {
      await sendPrinting();
    }
  }
}